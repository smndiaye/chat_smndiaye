{
  "variables": {
    "aws_access_key": "{{env `AWS_PACKER_TERRAFORM_ACCESS_KEY`}}",
    "aws_secret_key": "{{env `AWS_PACKER_TERRAFORM_SECRET_KEY`}}",
    "rails_setup_script": "rails_setup.sh",
    "repo_url": "git@github.com:smndiaye/jotaay.git",
    "ami_name": "deploy_server {{timestamp}}",
    "github_key": "packer/deploy_server/files/id_rsa"
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "ap-northeast-1",
    "availability_zone" : "ap-northeast-1a",
    "source_ami": "ami-92df37ed",
    "instance_type": "t2.micro",
    "ssh_username": "ec2-user",
    "ami_name": "{{user `ami_name`}}"
  }],
  "provisioners":
  [
    {
      "type": "file",
      "source": "{{user `github_key`}}",
      "destination": "~/.ssh/id_rsa"
    },
    {
      "type": "file",
      "source": "packer/deploy_server/files/ssh_config",
      "destination": "~/.ssh/config"
    },
    {
      "type": "shell",
      "inline":
      [
        "chmod 400 ~/.ssh/config",
        "chmod 400 ~/.ssh/id_rsa"
      ]
    },
    {
      "type": "file",
      "source": "packer/deploy_server/scripts/rails_setup.sh",
      "destination": "/tmp/{{user `rails_setup_script`}}"
    },
    {
      "type": "shell",
      "inline":
      [
        "chmod u+x /tmp/{{user `rails_setup_script`}}",
        "/tmp/{{user `rails_setup_script`}} --repo-url={{user `repo_url`}}"
      ]
    }
  ]
}