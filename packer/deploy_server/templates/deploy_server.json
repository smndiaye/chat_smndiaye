{
  "variables": {
    "rails_setup_script": "rails_setup.sh",
    "repo_url": "git@github.com:smndiaye/jotaay.git",
    "ami_name": "deploy_server_{{timestamp}}",
    "github_key": "packer/deploy_server/files/id_rsa",
    "bashrc": "packer/deploy_server/files/bashrc"
  },
  "builders": [{
    "type": "amazon-ebs",
    "profile": "jotaay",
    "region": "ap-northeast-1",
    "availability_zone" : "ap-northeast-1a",
    "source_ami": "ami-92df37ed",
    "instance_type": "t2.micro",
    "ssh_username": "ec2-user",
    "ami_name": "{{user `ami_name`}}"
  }],
  "provisioners":
  [
    {
      "type": "file",
      "source": "{{user `github_key`}}",
      "destination": "~/.ssh/id_rsa"
    },
    {
      "type": "file",
      "source": "packer/deploy_server/files/ssh_config",
      "destination": "~/.ssh/config"
    },
    {
      "type": "file",
      "source": "{{user `bashrc`}}",
      "destination": "~/.bashrc"
    },
    {
      "type": "shell",
      "inline":
      [
        "chmod 400 ~/.ssh/config ~/.ssh/id_rsa",
        ". ~/.bashrc"
      ]
    },
    {
      "type": "file",
      "source": "packer/deploy_server/scripts/rails_setup.sh",
      "destination": "/tmp/{{user `rails_setup_script`}}"
    },
    {
      "type": "shell",
      "inline":
      [
        "chmod u+x /tmp/{{user `rails_setup_script`}}",
        "/tmp/{{user `rails_setup_script`}} --repo-url={{user `repo_url`}}"
      ]
    }
  ]
}